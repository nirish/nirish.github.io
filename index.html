<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Dram Tracker PWA</title>

    <!-- 1. PWA Manifest & iOS Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Dram Tracker">
    <meta name="theme-color" content="#065f46">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- 2. Load Libraries (Global/UMD/Compat) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (CORE UMD - More stable) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Firebase (v8 - CORRECTED URLs) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- 3. Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Lucide icons default size */
        .lucide {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
        }
        /* CSS for Liquid Animation */
        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
         @keyframes wave-slow {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0); }
        }
        .animate-wave {
            animation: wave 12s linear infinite;
        }
         .animate-wave-slow {
            animation: wave-slow 18s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    
    <!-- App root -->
    <div id="root"></div>

    <!-- 4. PWA Service Worker Registration -->
    <script>
        // This is enabled for your live GitHub Pages deployment
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registered:', registration))
                    .catch(error => console.error('SW registration failed:', error));
            });
        }
    </script>

    <!-- 5. The React Application -->
    <script type="text/babel">
// Get React functions from the window
const { useState, useEffect, useMemo, useCallback, Fragment } = React;
// We now use global access for Firebase modules
const initializeApp = firebase.initializeApp;
const getAuth = firebase.auth;
const GoogleAuthProvider = firebase.auth.GoogleAuthProvider;
const signInWithPopup = firebase.auth.signInWithPopup;
const signOut = firebase.auth.signOut;
const onAuthStateChanged = firebase.auth.onAuthStateChanged;
const getFirestore = firebase.firestore;
const doc = (db, path) => { /* Placeholder for v9 doc function */ };
const setDoc = (ref, data, options) => ref.set(data, options); // v8 compat
const collection = (db, path) => db.collection(path); // v8 compat
const query = (colRef) => colRef; // v8 compat
const onSnapshot = (ref, callback, errorCallback) => ref.onSnapshot(callback, errorCallback); // v8 compat
const getDocs = (query) => query.get(); // v8 compat
const deleteDoc = (docRef) => docRef.delete(); // v8 compat


// --- Global Constants ---
const DAYS_IN_SABBATICAL = 107;
const TOTAL_TRACKING_WEEKS = 37;
const SABBATICAL_END_WEEK = 15; // Approx. 107 / 7
const DRINK_VOLUME_ML = 45;
const BOTTLE_VOLUME_ML = 750;
const DEFAULT_GOAL = 1.8;
const BINGE_THRESHOLD = 4; // 4+ drinks is a binge

// --- Firebase Config (From your verified file) ---
const firebaseConfig = {
    apiKey: "AIzaSyD92lDT-pbCB-EmtnTaEUhyql-CCYsLhho",
    authDomain: "dram-50c7c.firebaseapp.com",
    projectId: "dram-50c7c",
    storageBucket: "dram-50c7c.firebasestorage.app",
    messagingSenderId: "645616473221",
    appId: "1:645616473221:web:3a79dd9a2313f01bd0c5ec",
    measurementId: "G-VL3RYR0YRD"
};

// --- Initialize Firebase (v8 Compat syntax) ---
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
const auth = firebase.auth();
const appId = "dram-50c7c"; // Your Project ID

// --- Utility Functions ---
const round = (num) => Math.round(num * 100) / 100;

const getDayOfYear = (date) => {
  const dateUTC = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
  const startOfYear = new Date(Date.UTC(dateUTC.getUTCFullYear(), 0, 1));
  const diff = dateUTC.getTime() - startOfYear.getTime();
  const oneDay = 1000 * 60 * 60 * 24;
  return Math.floor(diff / oneDay) + 1;
};

const getCalendarWeek = (date) => {
    const doy = getDayOfYear(date);
    return Math.min(Math.floor((doy - 1) / 7) + 1, 53); 
};

const getElapsedTrackingWeeks = (date) => {
  const doy = getDayOfYear(date);
  if (doy <= DAYS_IN_SABBATICAL) return 0;
  const currentWeek = getCalendarWeek(date);
  const elapsedWeeks = currentWeek - SABBATICAL_END_WEEK;
  return Math.max(1, Math.min(elapsedWeeks, TOTAL_TRACKING_WEEKS));
};

const isSabbatical = (date) => getDayOfYear(date) <= DAYS_IN_SABBATICAL;

const formatDate = (date) => date.toISOString().split('T')[0];

// --- COMPONENT: Full Screen Liquid Background ---
const BackgroundLiquid = ({ percent }) => {
    const fillHeight = Math.min(Math.max(percent, 0), 100);
    
    const WaveSvg = ({fillClass}) => (
        <svg viewBox="0 0 500 150" preserveAspectRatio="none" className={`h-full w-full ${fillClass}`}>
            <path d="M0.00,49.98 C150.00,80.00 350.00,20.00 500.00,49.98 L500.00,150.00 L0.00,150.00 Z"></path>
        </svg>
    );

    return (
        <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden bg-gray-50">
            <div 
                className="absolute bottom-0 left-0 right-0 transition-all duration-[2000ms] ease-in-out"
                style={{ height: `${fillHeight}%` }}
            >
                <div className="absolute inset-0 top-6 bg-amber-500/40"></div>
                <div className="absolute top-0 left-0 w-[200%] h-24 -mt-12 opacity-40 animate-wave-slow flex">
                     <WaveSvg fillClass="fill-amber-600" />
                     <WaveSvg fillClass="fill-amber-600" />
                </div>
                <div className="absolute top-0 left-0 w-[200%] h-20 -mt-8 opacity-50 animate-wave flex">
                     <WaveSvg fillClass="fill-amber-500" />
                     <WaveSvg fillClass="fill-amber-500" />
                </div>
            </div>
        </div>
    );
};

// --- Main Logic Hook ---
const useTrackerMetrics = (dailyLog, goalDrinksPerWeek) => { 
    const today = useMemo(() => {
        const now = new Date();
        return new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    }, []);
    
    const lastLogDateString = useMemo(() => {
        const loggedDates = Object.keys(dailyLog).sort();
        let latestDate = null;
        for (const dateStr of loggedDates.reverse()) {
            const date = new Date(dateStr + 'T00:00:00Z');
            if (!isSabbatical(date)) {
                latestDate = dateStr;
                break;
            }
        }
        return latestDate;
    }, [dailyLog]);
    
    const pacingReferenceDate = useMemo(() => {
        if (lastLogDateString) {
            return new Date(lastLogDateString + 'T00:00:00Z'); 
        }
        return today; 
    }, [lastLogDateString, today]);
    
    const elapsedTrackingWeeks = useMemo(() => getElapsedTrackingWeeks(pacingReferenceDate), [pacingReferenceDate]);

    const metrics = useMemo(() => {
        let totalDrinksConsumed = 0;
        let sabbaticalExceptions = 0;
        let trackingPeriodDrinks = 0;
        
        const totalGoalDrinksFloat = goalDrinksPerWeek * TOTAL_TRACKING_WEEKS;
        const totalGoalBottlesFloat = (totalGoalDrinksFloat * DRINK_VOLUME_ML) / BOTTLE_VOLUME_ML;
        
        const totalGoalDrinks = Math.round(totalGoalDrinksFloat);
        const totalGoalBottles = round(totalGoalBottlesFloat);
        
        Object.values(dailyLog).forEach(entry => {
            totalDrinksConsumed += entry.drinks;
            const date = new Date(entry.date + 'T00:00:00Z'); 
            
            if (isSabbatical(date)) {
                if (entry.drinks > 0) {
                    sabbaticalExceptions += entry.drinks;
                }
            } else {
                trackingPeriodDrinks += entry.drinks;
            }
        });
        
        let pacingAvgPerWeek = 0;
        let totalProjectedDrinks = 0;
        let bottlesProjected = 0;

        if (elapsedTrackingWeeks > 0) {
            pacingAvgPerWeek = round(trackingPeriodDrinks / elapsedTrackingWeeks);
            totalProjectedDrinks = pacingAvgPerWeek * TOTAL_TRACKING_WEEKS;
            bottlesProjected = round((totalProjectedDrinks * DRINK_VOLUME_ML) / BOTTLE_VOLUME_ML);
        }

        const percentOfGoal = totalGoalDrinks > 0 
            ? (trackingPeriodDrinks / totalGoalDrinks) * 100
            : (trackingPeriodDrinks > 0 ? 100 : 0); 
        
        const drinksReserve = totalGoalDrinks - trackingPeriodDrinks - sabbaticalExceptions;
        
        return {
            totalGoalDrinks,
            totalGoalBottles,
            totalDrinksConsumed,
            elapsedTrackingWeeks,
            pacingAvgPerWeek,
            bottlesProjected,
            percentOfGoal, 
            drinksOnReserve: Math.round(drinksReserve),
            projectedAnnualDrinks: Math.round(totalProjectedDrinks),
            sabbaticalExceptions,
            trackingPeriodDrinks: trackingPeriodDrinks,
        };
        
    }, [dailyLog, elapsedTrackingWeeks, goalDrinksPerWeek, lastLogDateString]); 
    
    return metrics;
};

// --- HELPER FUNCTION: Calculate Pacing Zones ---
const calculateWeeklyPacing = (weeklyData, goalDrinksPerWeek) => {
    const sortedWeekKeys = Object.keys(weeklyData).sort();
    
    let cumulativeTrackingDrinks = 0;
    let elapsedTrackingWeeks = 0;
    
    const pacedWeeklyData = { ...weeklyData };

    for (const weekKey of sortedWeekKeys) {
        const week = pacedWeeklyData[weekKey];
        
        // --- Binge Detection ---
        let isBingeWeek = false;
        for (const dayDrinks of Object.values(week.days)) {
            if (dayDrinks >= BINGE_THRESHOLD) {
                isBingeWeek = true;
                break; 
            }
        }
        week.isBingeWeek = isBingeWeek;
        // --- End Binge Detection ---

        if (week.isSabbatical) {
            week.status = 'Exception'; 
            week.color = 'amber';
            continue;
        }

        elapsedTrackingWeeks++;
        cumulativeTrackingDrinks += week.totalDrinks;
        
        const cumulativeGoal = elapsedTrackingWeeks * goalDrinksPerWeek;
        const weeklyReserve = cumulativeGoal - cumulativeTrackingDrinks;
        
        if (weeklyReserve < 0) {
            week.status = 'Ease Up';
            week.color = 'red';
        } else if (weeklyReserve <= 5) {
            week.status = 'On Track';
            week.color = 'amber';
        } else {
            week.status = 'Extra Sober';
            week.color = 'green';
        }
    }
    
    return pacedWeeklyData;
};

// --- Main App Component ---
function App() {
    // --- 1. STATE HOOKS (Unconditional) ---
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [loading, setLoading] = useState(true);
    const [dailyLog, setDailyLog] = useState({});
    
    const [goalDrinksPerWeek, setGoalDrinksPerWeek] = useState(DEFAULT_GOAL); 
    const [tempGoalInput, setTempGoalInput] = useState(DEFAULT_GOAL); 
    const [isGoalCollapsed, setIsGoalCollapsed] = useState(true); 

    const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
    const [currentDrinks, setCurrentDrinks] = useState(0);

    // --- 2. MEMO/PROVIDER HOOKS (Unconditional) ---
    const googleProvider = useMemo(() => new GoogleAuthProvider(), []);
    const metrics = useTrackerMetrics(dailyLog, goalDrinksPerWeek);

    // --- 3. WEEKLY DATA HOOKS (Unconditional) ---
    const getWeeklyData = useCallback(() => {
        const weeks = {};
        const dates = Object.keys(dailyLog).sort();
        dates.forEach(dateStr => {
            const date = new Date(dateStr + 'T00:00:00Z'); 
            let currentDayOfWeek = date.getUTCDay();
            let daysToFriday = currentDayOfWeek <= 4 ? currentDayOfWeek + 2 : currentDayOfWeek - 5;
            const fridayDate = new Date(date);
            fridayDate.setUTCDate(date.getUTCDate() - daysToFriday);
            const weekKey = formatDate(fridayDate);
            const calendarWeek = getCalendarWeek(date);

            if (!weeks[weekKey]) {
                weeks[weekKey] = {
                    startDate: fridayDate,
                    totalDrinks: 0,
                    days: {},
                    calendarWeekNumber: calendarWeek,
                    isSabbatical: isSabbatical(date) 
                };
            }
            const logEntry = dailyLog[dateStr];
            weeks[weekKey].totalDrinks += logEntry.drinks;
            weeks[weekKey].days[dateStr] = logEntry.drinks;
        });
        return weeks;
    }, [dailyLog]);
    
    const weeklyData = useMemo(() => getWeeklyData(), [dailyLog]);
    const pacedWeeklyData = useMemo(() => calculateWeeklyPacing(weeklyData, goalDrinksPerWeek), [weeklyData, goalDrinksPerWeek]);
    const sortedWeeks = useMemo(() => Object.keys(pacedWeeklyData).sort().reverse(), [pacedWeeklyData]);

    // --- 4. CALLBACK HOOKS (Unconditional) ---
    const handleGoogleSignIn = useCallback(async () => {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            console.error("Google Sign-In Failed:", error);
        }
    }, [auth, googleProvider]);

    const handleSignOut = useCallback(async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Sign Out Failed:", error);
        }
    }, [auth]);

    const handleDateChange = (e) => setSelectedDate(e.target.value);
    const handleIncrement = () => setCurrentDrinks(prev => prev + 1);
    const handleDecrement = () => setCurrentDrinks(prev => Math.max(0, prev - 1));

    const handleSaveLog = useCallback(async () => {
        if (!userId) return;
        const docRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`).doc(selectedDate);
        try {
            await docRef.set({
                date: selectedDate,
                drinks: currentDrinks,
                timestamp: new Date(),
            }, { merge: true });
            console.log("Log saved/edited successfully for:", selectedDate);
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    }, [userId, selectedDate, currentDrinks]);

    const handleSaveGoal = useCallback(async () => {
        if (!userId) return;
        const newGoal = parseFloat(tempGoalInput);
        if (isNaN(newGoal) || newGoal < 0) return;
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        try {
            await goalDocRef.set({
                goalDrinksPerWeek: round(newGoal),
                lastUpdated: new Date(),
            }, { merge: true });
            console.log("Goal saved successfully:", round(newGoal));
            setIsGoalCollapsed(true);
        } catch (e) {
            console.error("Error saving goal: ", e);
        }
    }, [userId, tempGoalInput]);
    
    const handleResetData = useCallback(async () => {
        if (!userId) return;
        console.warn("Attempting to RESET ALL DATA.");
        const logCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`);
        try {
            const snapshot = await logCollectionRef.get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            console.log("Successfully deleted all drink log documents.");
        } catch (e) {
            console.error("Error deleting documents:", e);
        }
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        try {
            await goalDocRef.set({
                goalDrinksPerWeek: DEFAULT_GOAL,
                lastUpdated: new Date(),
            });
            console.log(`Goal reset to default: ${DEFAULT_GOAL}`);
        } catch (e) {
            console.error("Error resetting goal: ", e);
        }
    }, [userId]);

    // --- 5. EFFECT HOOKS (Unconditional) ---
    useEffect(() => {
        if (!auth) { setLoading(false); return; }
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            if (user) {
                setUserId(user.uid);
                setLoading(false);
            } else {
                setUserId(null);
                setLoading(false);
            }
            setIsAuthReady(true);
        });
        return () => unsubscribe();
    }, [auth]);

    useEffect(() => {
        if (!isAuthReady || !userId) return;
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        const unsubscribe = goalDocRef.onSnapshot((docSnapshot) => {
            if (docSnapshot.exists) {
                const data = docSnapshot.data();
                const newGoal = parseFloat(data.goalDrinksPerWeek) || DEFAULT_GOAL; 
                setGoalDrinksPerWeek(newGoal);
                setTempGoalInput(newGoal);
            } else {
                setGoalDrinksPerWeek(DEFAULT_GOAL);
                setTempGoalInput(DEFAULT_GOAL);
            }
        }, (error) => { console.error("Error listening to goals:", error); });
        return () => unsubscribe();
    }, [isAuthReady, userId]);

    useEffect(() => {
        if (!isAuthReady || !userId) return;
        const logCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`);
        const unsubscribe = logCollectionRef.onSnapshot((snapshot) => {
            const newLog = {};
            snapshot.forEach((doc) => {
                const data = doc.data();
                newLog[data.date] = data;
            });
            setDailyLog(newLog);
            const logEntry = newLog[selectedDate];
            if (logEntry) {
                setCurrentDrinks(logEntry.drinks);
            } else if (!newLog[selectedDate]) {
                setCurrentDrinks(0);
            }
        }, (error) => { console.error("Error listening to log:", error); });
        return () => unsubscribe();
    }, [isAuthReady, userId, selectedDate]);

    useEffect(() => {
        const logEntry = dailyLog[selectedDate];
        setCurrentDrinks(logEntry ? logEntry.drinks : 0);
    }, [selectedDate, dailyLog]);
    
    useEffect(() => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }, [loading, isGoalCollapsed, metrics]);

    // --- RENDER GATES ---
    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="text-emerald-600 font-semibold text-lg">Loading tracker...</div>
            </div>
        );
    }

    if (!userId) {
        return (
            <div className="min-h-screen font-sans relative flex items-center justify-center p-8">
                <BackgroundLiquid percent={0} />
                <div className="relative z-10 p-6 bg-white/90 backdrop-blur-md rounded-xl shadow-2xl max-w-sm text-center">
                    <Flame className="w-12 h-12 text-amber-600 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-emerald-900 mb-4">Sober*ish Tracker</h2>
                    <p className="text-sm text-gray-600 mb-6">
                        Please sign in to securely save your goals and consumption history across all your devices.
                    </p>
                    <button
                        onClick={handleGoogleSignIn}
                        className="w-full flex items-center justify-center bg-emerald-600 text-white py-3 rounded-lg font-semibold text-lg shadow-lg hover:bg-emerald-700 transition duration-150"
                    >
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" className="mr-2">
                            <path d="M12.0003 12.7214C12.0003 13.5658 12.0623 14.3411 12.2272 15.0898H11.9984C9.56947 15.0898 7.62534 13.1466 7.62534 10.7186C7.62534 8.28976 9.56947 6.34657 11.9984 6.34657C13.2505 6.34657 14.383 6.78601 15.2536 7.6062L16.7118 6.13605C15.6025 5.02678 13.9167 4.34657 11.9984 4.34657C8.45524 4.34657 5.59961 7.20221 5.59961 10.7454C5.59961 14.2886 8.45524 17.1442 11.9984 17.1442C15.5416 17.1442 18.3972 14.2886 18.3972 10.7454C18.3972 10.4285 18.3582 10.1116 18.2982 9.80373H11.9984V12.7214Z" fill="white"/>
                        </svg>
                        Sign in with Google
                    </button>
                    <p className="mt-4 text-xs text-gray-500">
                        Your data is secured by your Google account.
                    </p>
                </div>
            </div>
        );
    }
    // --- END AUTHENTICATION GATE ---
    
    const currentDay = new Date(selectedDate + 'T00:00:00Z');
    
    return (
        <div className="min-h-screen font-sans relative">
            
            <BackgroundLiquid percent={metrics.percentOfGoal} />

            <div className="relative z-10 p-4 max-w-lg mx-auto">
                
                <header className="py-4 mb-6 border-b border-amber-300/50 flex justify-between items-center">
                    <h1 className="text-3xl font-extrabold text-emerald-900 flex items-center drop-shadow-sm">
                        <Flame className="w-8 h-8 mr-2 text-amber-600" />
                        Sober*ish
                    </h1>
                    
                    <div className="text-right flex flex-col items-end">
                        <button 
                            onClick={handleSignOut} 
                            className="text-xs text-red-500 hover:text-red-700 mb-2 flex items-center p-1 rounded-full bg-white/50 backdrop-blur-sm shadow-sm"
                            aria-label="Sign out"
                        >
                            <LogOut className="w-3 h-3 mr-1" /> Sign Out
                        </button>
                        <p className="text-xs text-emerald-900 font-semibold drop-shadow-sm">
                            {goalDrinksPerWeek.toFixed(2)} <span className="text-gray-700 font-normal">drinks/week</span>
                        </p>
                        <p className="text-xs text-emerald-900 font-semibold drop-shadow-sm">
                            {metrics.totalGoalDrinks} <span className="text-gray-700 font-normal">annual drinks</span>
                        </p>
                        <p className="text-xs text-emerald-900 font-semibold drop-shadow-sm">
                            {Math.round(metrics.totalGoalBottles)} <span className="text-gray-700 font-normal">annual bottles</span>
                        </p>
                    </div>
                </header>
                
                <section className="mb-8 p-4 bg-white/70 backdrop-blur-md rounded-xl shadow-xl border border-emerald-100">
                    <div className="flex justify-between items-center cursor-pointer" onClick={() => setIsGoalCollapsed(!isGoalCollapsed)}>
                        <h2 className="text-lg font-bold text-emerald-800 flex items-center">
                            <Goal className="w-5 h-5 mr-2 text-emerald-600" /> Annual Goal Setting
                        </h2>
                        {isGoalCollapsed ? <ChevronDown className="w-5 h-5 text-emerald-600" /> : <ChevronUp className="w-5 h-5 text-emerald-600" />}
                    </div>

                    {!isGoalCollapsed && (
                        <div className="mt-4 pt-3 border-t border-emerald-200">
                            
                            <div className="grid grid-cols-3 gap-3 mb-6">
                                <MetricCard
                                    title="Goal / Week"
                                    value={goalDrinksPerWeek.toFixed(2)}
                                    icon={Calculator}
                                    colorClass="bg-white/60"
                                />
                                <MetricCard
                                    title="Annual Drinks"
                                    value={metrics.totalGoalDrinks} 
                                    icon={Goal}
                                    colorClass="bg-white/60"
                                />
                                <MetricCard
                                    title="Annual Bottles"
                                    value={metrics.totalGoalBottles.toFixed(2)} 
                                    icon={Wine}
                                    colorClass="bg-white/60"
                                />
                            </div>

                            <div className="grid grid-cols-3 gap-4 items-end">
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-emerald-700 mb-1">Drinks Goal / Week (e.g., 1.8)</label>
                                    <input
                                        type="number"
                                        value={tempGoalInput}
                                        onChange={(e) => setTempGoalInput(e.target.value)}
                                        min="0"
                                        step="0.1"
                                        className="w-full p-2 border border-emerald-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 bg-white/50"
                                    />
                                </div>
                                <button
                                    onClick={handleSaveGoal}
                                    className="w-full bg-emerald-600 text-white py-2 rounded-lg font-semibold text-sm shadow-md hover:bg-emerald-700 transition duration-150"
                                >
                                    Update Goal
                                </button>
                            </div>
                             <div className="mt-6">
                                <button
                                    onClick={handleResetData}
                                    className="w-full flex items-center justify-center bg-gray-200 text-red-600 py-2 rounded-lg font-semibold text-sm shadow-md hover:bg-gray-300 transition duration-150"
                                >
                                    <Trash2 className="w-4 h-4 mr-2" />
                                    Reset All Data (Log & Goal)
                                </button>
                                <p className="text-xs text-gray-500 mt-2 text-center">
                                    *This action is irreversible and clears your log history and resets the goal to {DEFAULT_GOAL}.
                                </p>
                            </div>
                        </div>
                    )}
                </section>
                
                <section className="mb-8 p-4 bg-white/70 backdrop-blur-md rounded-xl shadow-xl border border-emerald-100">
                    <h2 className="text-lg font-bold mb-4 text-emerald-800">Log Daily Consumption</h2>
                    
                    <div className="flex gap-4">
                        
                        <div className="w-2/3 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Select Date</label>
                                <input
                                    type="date"
                                    value={selectedDate}
                                    onChange={handleDateChange}
                                    className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 bg-white/60"
                                    max={formatDate(new Date())}
                                />
                            </div>
                            
                            <div className="text-center">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Drams/Drinks Consumed</label>
                                <div className="flex justify-between items-center space-x-2">
                                    <button
                                        onClick={handleDecrement}
                                        className="p-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-full shadow-md transition duration-150 active:bg-gray-400 disabled:opacity-50"
                                        disabled={currentDrinks <= 0}
                                        aria-label="Decrement drinks"
                                    >
                                        <Minus className="w-5 h-5" />
                                    </button>

                                    <div className="flex-grow text-center">
                                        <span className="text-4xl font-extrabold text-emerald-800 tabular-nums">
                                            {currentDrinks}
                                        </span>
                                    </div>

                                    <button
                                        onClick={handleIncrement}
                                        className="p-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full shadow-md transition duration-150 active:bg-emerald-700"
                                        aria-label="Increment drinks"
                                    >
                                        <Plus className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="w-1/3 flex items-stretch justify-center">
                            <ReservePill 
                                value={metrics.drinksOnReserve} 
                                unit="Drinks" 
                            />
                        </div>
                    </div>
                    
                    <button
                        onClick={handleSaveLog}
                        className="mt-5 w-full bg-emerald-600 text-white py-3 rounded-xl font-semibold text-lg shadow-lg hover:bg-emerald-700 transition duration-150 transform hover:scale-[1.01]"
                    >
                        {dailyLog[selectedDate] ? `Overwrite Log with ${currentDrinks} Drinks` : `Save ${currentDrinks} Drinks`}
                    </button>
                </section>
                
                <section className="mb-8">
                    <h2 className="text-xl font-bold mb-4 text-emerald-900 drop-shadow-sm">
                        Pacing Metrics
                    </h2>
                    
                    <div className="grid grid-cols-3 gap-3 mb-4">
                        <MetricCard
                            title="Avg / Week"
                            value={metrics.pacingAvgPerWeek.toFixed(2)}
                            unit={`vs ${goalDrinksPerWeek.toFixed(1)} goal`}
                            icon={Calculator}
                            colorClass="bg-white/60"
                        />
                        <MetricCard
                            title="Bottle Pace"
                            value={metrics.bottlesProjected.toFixed(2)}
                            unit="Annual Pacing"
                            icon={Wine}
                            colorClass={metrics.bottlesProjected > metrics.totalGoalBottles ? 'bg-red-100/70' : 'bg-emerald-100/70'}
                        />
                        <MetricCard
                            title="Total Consumed"
                            value={metrics.totalDrinksConsumed}
                            unit=""
                            icon={CalendarCheck}
                            colorClass="bg-white/60"
                        />
                    </div>
                </section>
                
                <section className="mb-20">
                    <h2 className="text-xl font-bold mb-4 text-emerald-900 drop-shadow-sm">Weekly Log (Friday-Thursday)</h2>
                    <div className="overflow-x-auto bg-white/70 backdrop-blur-md rounded-xl shadow-xl border border-emerald-100">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50/50">
                                <tr>
                                    <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week #</th>
                                    <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                    <th className="px-3 py-3 text-right text-xs font-numeric text-gray-500 uppercase tracking-wider">Drinks</th>
                                    <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody className="bg-transparent divide-y divide-gray-200">
                                {sortedWeeks.length === 0 ? (
                                    <tr>
                                        <td colSpan="4" className="p-4 text-center text-gray-500 italic">No logs found yet.</td>
                                    </tr>
                                ) : (
                                    sortedWeeks.map((weekKey) => {
                                        const week = pacedWeeklyData[weekKey];
                                        const endDate = new Date(week.startDate);
                                        endDate.setUTCDate(week.startDate.getUTCDate() + 6);
                                        const isOver = week.totalDrinks > goalDrinksPerWeek;
                                        const isCurrentWeek = getCalendarWeek(new Date()) === week.calendarWeekNumber;
                                        const weekLabel = week.isSabbatical 
                                            ? `Sabbatical Wk ${week.calendarWeekNumber}` 
                                            : `Wk ${week.calendarWeekNumber}`;

                                        let statusText = '';
                                        let statusColorClass = '';
                                        
                                        if (week.isSabbatical) {
                                            statusText = 'Exception';
                                            statusColorClass = 'bg-amber-100 text-amber-800';
                                        } else if (week.color === 'red') {
                                            statusText = week.status;
                                            statusColorClass = 'bg-red-100 text-red-800';
                                        } else if (week.color === 'amber') {
                                            statusText = week.status;
                                            statusColorClass = 'bg-amber-100 text-amber-800';
                                        } else {
                                            statusText = week.status;
                                            statusColorClass = 'bg-emerald-100 text-emerald-800';
                                        }
                                        
                                        const bingeEmoji = week.isBingeWeek ? 'ðŸ”¥ ' : '';

                                        return (
                                            <tr key={weekKey} className={`transition duration-100 ${isCurrentWeek ? 'bg-emerald-100/50 font-semibold' : 'hover:bg-emerald-50/50'}`}>
                                                <td className="px-3 py-3 whitespace-nowLrap text-sm text-gray-900">{weekLabel}</td>
                                                <td className="px-3 py-3 whitespace-nowrap text-xs text-gray-500">
                                                    {weekKey.slice(5)} - {formatDate(endDate).slice(5)}
                                                </td>
                                                <td className="px-3 py-3 whitespace-nowrap text-sm text-right">
                                                    <span className={`font-bold ${week.totalDrinks > 0 && isOver && !week.isSabbatical ? 'text-red-600' : 'text-emerald-600'}`}>
                                                        {week.totalDrinks}
                                                    </span>
                                                </td>
                                                <td className="px-3 py-3 whitespace-nowrap text-sm text-right">
                                                    <span className={`text-xs font-medium px-2 py-1 rounded-full ${statusColorClass}`}>
                                                        {bingeEmoji}{statusText}
                                                    </span>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </section>

            </div>
        </div>
    );
}

// --- Mount the App ---
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
