
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Dram Tracker PWA</title>

    <!-- 1. PWA Manifest & iOS Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Dram Tracker">
    <meta name="theme-color" content="#065f46">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- 2. Load Libraries (Global/UMD/Compat) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (CORE UMD - More stable) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Firebase (v8 - CORRECTED URLs) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- 3. Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Lucide icons default size */
        .lucide {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    
    <!-- App root -->
    <div id="root"></div>

    <!-- 4. PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registered:', registration))
                    .catch(error => console.error('SW registration failed:', error));
            });
        }
    </script>

    <!-- 5. The React Application -->
    <script type="text/babel">
// Get React functions from the window
const { useState, useEffect, useMemo, useCallback, Fragment } = React;
// We no longer get icons from LucideReact, we will call a function instead.

// --- Global Constants ---
const DAYS_IN_SABBATICAL = 107;
const SABBATICAL_END_WEEK = 15;
const TOTAL_TRACKING_WEEKS = 37;
const DRINK_VOLUME_ML = 45;
const BOTTLE_VOLUME_ML = 750;
const DEFAULT_GOAL = 1.8;

// --- Firebase Config (From your verified file) ---
const firebaseConfig = {
    apiKey: "AIzaSyD92lDT-pbCB-EmtnTaEUhyql-CCYsLhho",
    authDomain: "dram-50c7c.firebaseapp.com",
    projectId: "dram-50c7c",
    storageBucket: "dram-50c7c.firebasestorage.app",
    messagingSenderId: "645616473221",
    appId: "1:645616473221:web:3a79dd9a2313f01bd0c5ec",
    measurementId: "G-VL3RYR0YRD"
};

// --- Initialize Firebase (v8 Compat syntax) ---
// We get 'firebase' from the script loaded in the <head>
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
const auth = firebase.auth();
const appId = "dram-50c7c"; // Your Project ID

// --- Utility Functions ---
const round = (num) => Math.round(num * 100) / 100;

const getDayOfYear = (date) => {
  const dateUTC = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
  const startOfYear = new Date(Date.UTC(dateUTC.getUTCFullYear(), 0, 1));
  const diff = dateUTC.getTime() - startOfYear.getTime();
  const oneDay = 1000 * 60 * 60 * 24;
  return Math.floor(diff / oneDay) + 1;
};

const getCalendarWeek = (date) => {
    const doy = getDayOfYear(date);
    return Math.min(Math.floor((doy - 1) / 7) + 1, 53); 
};

const getElapsedTrackingWeeks = (date) => {
  const doy = getDayOfYear(date);
  if (doy <= DAYS_IN_SABBATICAL) return 0;
  const currentWeek = getCalendarWeek(date);
  const elapsedWeeks = currentWeek - SABBATICAL_END_WEEK;
  return Math.max(1, Math.min(elapsedWeeks, TOTAL_TRACKING_WEEKS));
};

const isSabbatical = (date) => getDayOfYear(date) <= DAYS_IN_SABBATICAL;

const formatDate = (date) => date.toISOString().split('T')[0];


// --- Main Logic Hook ---
const useTrackerMetrics = (dailyLog, goalDrinksPerWeek) => { 
    const today = useMemo(() => {
        const now = new Date();
        return new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    }, []);
    
    const lastLogDateString = useMemo(() => {
        const loggedDates = Object.keys(dailyLog).sort();
        let latestDate = null;
        for (const dateStr of loggedDates.reverse()) {
            const date = new Date(dateStr + 'T00:00:00Z');
            if (!isSabbatical(date)) {
                latestDate = dateStr;
                break;
            }
        }
        return latestDate;
    }, [dailyLog]);
    
    const pacingReferenceDate = useMemo(() => {
        if (lastLogDateString) {
            return new Date(lastLogDateString + 'T00:00:00Z'); 
        }
        return today; 
    }, [lastLogDateString, today]);
    
    const elapsedTrackingWeeks = useMemo(() => getElapsedTrackingWeeks(pacingReferenceDate), [pacingReferenceDate]);

    const metrics = useMemo(() => {
        let totalDrinksConsumed = 0;
        let sabbaticalExceptions = 0;
        let trackingPeriodDrinks = 0;

        const totalGoalDrinksFloat = goalDrinksPerWeek * TOTAL_TRACKING_WEEKS;
        const totalGoalBottlesFloat = (totalGoalDrinksFloat * DRINK_VOLUME_ML) / BOTTLE_VOLUME_ML;
        
        const totalGoalDrinks = Math.round(totalGoalDrinksFloat);
        const totalGoalBottles = Math.round(totalGoalBottlesFloat);
        
        Object.values(dailyLog).forEach(entry => {
            totalDrinksConsumed += entry.drinks;
            const date = new Date(entry.date + 'T00:00:00Z'); 
            if (isSabbatical(date) && entry.drinks > 0) {
                sabbaticalExceptions += entry.drinks;
            }
            if (!isSabbatical(date)) {
                trackingPeriodDrinks += entry.drinks;
            }
        });
        
        const targetConsumedToDate = elapsedTrackingWeeks * goalDrinksPerWeek;

        let pacingAvgPerWeek = 0;
        let totalProjectedDrinks = 0;
        let bottlesProjected = 0;

        if (elapsedTrackingWeeks > 0) {
            pacingAvgPerWeek = round(trackingPeriodDrinks / elapsedTrackingWeeks);
            totalProjectedDrinks = pacingAvgPerWeek * TOTAL_TRACKING_WEEKS;
            bottlesProjected = round((totalProjectedDrinks * DRINK_VOLUME_ML) / BOTTLE_VOLUME_ML);
        }

        const percentOfGoal = totalGoalDrinks > 0 
            ? round((trackingPeriodDrinks / totalGoalDrinks) * 100)
            : (trackingPeriodDrinks > 0 ? 100 : 0); 
        
        const drinksReserve = totalGoalDrinks - trackingPeriodDrinks;
        
        return {
            totalGoalDrinks,
            totalGoalBottles,
            totalDrinksConsumed,
            elapsedTrackingWeeks,
            pacingAvgPerWeek,
            bottlesProjected,
            percentOfGoal,
            drinksOnReserve: Math.round(drinksReserve),
            projectedAnnualDrinks: Math.round(totalProjectedDrinks),
            sabbaticalExceptions,
            trackingPeriodDrinks,
            targetConsumedToDate: round(targetConsumedToDate)
        };
    }, [dailyLog, elapsedTrackingWeeks, goalDrinksPerWeek, lastLogDateString]); 
    
    return metrics;
};

// --- Main App Component ---
function App() {
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [loading, setLoading] = useState(true);
    const [dailyLog, setDailyLog] = useState({});
    
    const [goalDrinksPerWeek, setGoalDrinksPerWeek] = useState(DEFAULT_GOAL); 
    const [tempGoalInput, setTempGoalInput] = useState(DEFAULT_GOAL); 
    const [isGoalCollapsed, setIsGoalCollapsed] = useState(true); 

    const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
    const [currentDrinks, setCurrentDrinks] = useState(0);

    // 1. Firebase Authentication & Setup
    useEffect(() => {
        const setupAuth = async () => {
            try {
                await auth.signInAnonymously();
            } catch (error) {
                console.error("Auth error:", error);
            }
        };

        const unsubscribe = auth.onAuthStateChanged((user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                setUserId(null);
            }
            setIsAuthReady(true);
        });

        setupAuth();
        return () => unsubscribe();
    }, []);

    // 2. Firestore Listener for Goal Settings
    useEffect(() => {
        if (!isAuthReady || !userId) return;
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        const unsubscribe = goalDocRef.onSnapshot((docSnapshot) => {
            if (docSnapshot.exists) {
                const data = docSnapshot.data();
                const newGoal = parseFloat(data.goalDrinksPerWeek) || DEFAULT_GOAL; 
                setGoalDrinksPerWeek(newGoal);
                setTempGoalInput(newGoal);
            } else {
                setGoalDrinksPerWeek(DEFAULT_GOAL);
                setTempGoalInput(DEFAULT_GOAL);
            }
            setLoading(false);
        }, (error) => {
            console.error("Error listening to goals:", error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [isAuthReady, userId]);

    // 3. Firestore Listener for Daily Log
    useEffect(() => {
        if (!isAuthReady || !userId) return;
        const logCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`);
        const unsubscribe = logCollectionRef.onSnapshot((snapshot) => {
            const newLog = {};
            snapshot.forEach((doc) => {
                const data = doc.data();
                newLog[data.date] = data;
            });
            setDailyLog(newLog);
            const logEntry = newLog[selectedDate];
            if (logEntry) {
                setCurrentDrinks(logEntry.drinks);
            } else if (!newLog[selectedDate]) {
                setCurrentDrinks(0);
            }
        }, (error) => {
            console.error("Error listening to log:", error);
        });
        return () => unsubscribe();
    }, [isAuthReady, userId, selectedDate]);

    // Update currentDrinks when selectedDate changes
    useEffect(() => {
        const logEntry = dailyLog[selectedDate];
        setCurrentDrinks(logEntry ? logEntry.drinks : 0);
    }, [selectedDate, dailyLog]);
    
    // NEW: Icon Rendering Effect
    // This runs after every render to find all `data-lucide` attributes
    // and replace them with SVG icons. This is the stable fix.
    useEffect(() => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }, [loading, isGoalCollapsed, metrics]); // Re-run when state changes
    
    const metrics = useTrackerMetrics(dailyLog, goalDrinksPerWeek); 

    // --- Actions ---
    const handleDateChange = (e) => setSelectedDate(e.target.value);
    const handleIncrement = () => setCurrentDrinks(prev => prev + 1);
    const handleDecrement = () => setCurrentDrinks(prev => Math.max(0, prev - 1));

    const handleSaveLog = useCallback(async () => {
        if (!userId) return;
        const docRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`).doc(selectedDate);
        try {
            await docRef.set({
                date: selectedDate,
                drinks: currentDrinks,
                timestamp: new Date(),
            }, { merge: true });
            console.log("Log saved/edited successfully for:", selectedDate);
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    }, [userId, selectedDate, currentDrinks]);

    const handleSaveGoal = useCallback(async () => {
        if (!userId) return;
        const newGoal = parseFloat(tempGoalInput);
        if (isNaN(newGoal) || newGoal < 0) return;
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        try {
            await goalDocRef.set({
                goalDrinksPerWeek: round(newGoal),
                lastUpdated: new Date(),
            }, { merge: true });
            console.log("Goal saved successfully:", round(newGoal));
            setIsGoalCollapsed(true);
        } catch (e) {
            console.error("Error saving goal: ", e);
        }
    }, [userId, tempGoalInput]);
    
    const handleResetData = useCallback(async () => {
        if (!userId) return;
        console.warn("Attempting to RESET ALL DATA.");
        const logCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/drink_tracker`);
        try {
            const snapshot = await logCollectionRef.get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            console.log("Successfully deleted all drink log documents.");
        } catch (e) {
            console.error("Error deleting documents:", e);
        }
        const goalDocRef = db.collection(`artifacts/${appId}/users/${userId}/settings`).doc('goals');
        try {
            await goalDocRef.set({
                goalDrinksPerWeek: DEFAULT_GOAL,
                lastUpdated: new Date(),
            });
            console.log(`Goal reset to default: ${DEFAULT_GOAL}`);
        } catch (e) {
            console.error("Error resetting goal:", e);
        }
    }, [userId]);

    // --- UI Components ---
    // Note: We use <i> tags with `data-lucide` instead of React components
    const MetricCard = ({ title, value, unit, icon, colorClass = 'bg-gray-100' }) => (
        <div className={`p-3 rounded-xl shadow-lg flex flex-col items-center justify-center ${colorClass} text-gray-800 transition duration-300 transform hover:scale-[1.02] border border-opacity-20`}>
            <div className="flex items-center space-x-1 mb-1">
                <i data-lucide={icon} className="w-4 h-4 text-emerald-600 opacity-80"></i>
                <h3 className="text-[10px] font-semibold uppercase tracking-wider text-gray-500">{title}</h3>
            </div>
            <p className="text-xl font-extrabold text-emerald-800">
                {value}
            </p>
            {unit && <span className="text-[10px] font-medium text-gray-600 mt-0.5">{unit}</span>}
        </div>
    );
    
    const ReservePill = ({ value, unit }) => {
        const isOver = value < 0;
        const sign = value > 0 ? '+' : (value < 0 ? '' : '');
        const absoluteValue = Math.abs(Math.round(value)); 
        const colorClass = isOver 
            ? 'bg-red-700 text-white shadow-lg shadow-red-400'
            : 'bg-emerald-600 text-white shadow-lg shadow-emerald-400';

        return (
            <div className={`p-2 rounded-xl flex flex-col items-center justify-center h-full w-full transition duration-300 ${colorClass}`}>
                <h3 className="text-[10px] font-semibold uppercase tracking-wider opacity-80 mb-0.5">Reserve</h3>
                <p className="text-3xl font-extrabold">
                    {sign}{absoluteValue} 
                </p>
                <span className="text-[10px] font-medium opacity-80">{unit}</span>
            </div>
        );
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="text-emerald-600 font-semibold text-lg">Loading tracker...</div>
            </div>
        );
    }
    
    const currentDay = new Date(selectedDate + 'T00:00:00Z');
    const isTodaySabbatical = isSabbatical(currentDay);

    const getWeeklyData = () => {
        const weeks = {};
        const dates = Object.keys(dailyLog).sort();
        dates.forEach(dateStr => {
            const date = new Date(dateStr + 'T00:00:00Z'); 
            let currentDayOfWeek = date.getUTCDay();
            let daysToFriday = currentDayOfWeek <= 4 ? currentDayOfWeek + 2 : currentDayOfWeek - 5;
            const fridayDate = new Date(date);
            fridayDate.setUTCDate(date.getUTCDate() - daysToFriday);
            const weekKey = formatDate(fridayDate);
            const calendarWeek = getCalendarWeek(date);

            if (!weeks[weekKey]) {
                weeks[weekKey] = {
                    startDate: fridayDate,
                    totalDrinks: 0,
                    days: {},
                    calendarWeekNumber: calendarWeek,
                    isSabbatical: isSabbatical(date) 
                };
            }
            const logEntry = dailyLog[dateStr];
            weeks[weekKey].totalDrinks += logEntry.drinks;
            weeks[weekKey].days[dateStr] = logEntry.drinks;
        });
        return weeks;
    };
    
    const weeklyData = getWeeklyData();
    const sortedWeeks = Object.keys(weeklyData).sort().reverse();
    
    return (
        <div className="min-h-screen bg-gray-50 p-4 max-w-lg mx-auto">
            <header className="py-4 mb-6 border-b border-amber-300">
                <h1 className="text-2xl font-extrabold text-emerald-800 flex items-center">
                    <i data-lucide="flame" className="w-6 h-6 mr-2 text-amber-500"></i>
                    Sober*ish
                </h1>
                <p className="text-sm text-gray-500 mt-1">
                    Tracking Goal: **{goalDrinksPerWeek.toFixed(2)} drinks/week** ({metrics.totalGoalDrinks} annual drinks).
                </p>
            </header>
            
            <section className="mb-8 p-4 bg-emerald-50 rounded-xl shadow-inner border border-emerald-200">
                <div className="flex justify-between items-center cursor-pointer" onClick={() => setIsGoalCollapsed(!isGoalCollapsed)}>
                    <h2 className="text-lg font-bold text-emerald-800 flex items-center">
                        <i data-lucide="goal" className="w-5 h-5 mr-2 text-emerald-600"></i> Annual Goal Setting
                    </h2>
                    {isGoalCollapsed ? <i data-lucide="chevron-down" className="w-5 h-5 text-emerald-600"></i> : <i data-lucide="chevron-up" className="w-5 h-5 text-emerald-600"></i>}
                </div>

                {!isGoalCollapsed && (
                    <div className="mt-4 pt-3 border-t border-emerald-200">
                        <div className="grid grid-cols-3 gap-4 items-end">
                            <div className="col-span-2">
                                <label className="block text-sm font-medium text-emerald-700 mb-1">Drinks Goal / Week (e.g., 1.8)</label>
                                <input
                                    type="number"
                                    value={tempGoalInput}
                                    onChange={(e) => setTempGoalInput(e.target.value)}
                                    min="0"
                                    step="0.1"
                                    className="w-full p-2 border border-emerald-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                                />
                            </div>
                            <button
                                onClick={handleSaveGoal}
                                className="w-full bg-emerald-600 text-white py-2 rounded-lg font-semibold text-sm shadow-md hover:bg-emerald-700 transition duration-150"
                            >
                                Update Goal
                            </button>
                        </div>
                         <div className="mt-6">
                            <button
                                onClick={handleResetData}
                                className="w-full flex items-center justify-center bg-gray-200 text-red-600 py-2 rounded-lg font-semibold text-sm shadow-md hover:bg-gray-300 transition duration-150"
                            >
                                <i data-lucide="trash-2" className="w-4 h-4 mr-2"></i>
                                Reset All Data (Log & Goal)
                            </button>
                            <p className="text-xs text-gray-500 mt-2 text-center">
                                *This action is irreversible and clears your log history and resets the goal to {DEFAULT_GOAL}.
                            </p>
                        </div>
                    </div>
                )}
            </section>
            
            <section className="mb-8">
                <h2 className="text-xl font-bold mb-4 text-emerald-800">Annual Goals</h2>
                <div className="grid grid-cols-3 gap-3">
                     <MetricCard
                        title="Goal / Week"
                        value={goalDrinksPerWeek.toFixed(2)}
                        icon="calculator"
                        colorClass="bg-white border border-gray-100"
                    />
                    <MetricCard
                        title="Annual Drinks"
                        value={metrics.totalGoalDrinks} 
                        icon="goal"
                        colorClass="bg-white border border-gray-100"
                    />
                    <MetricCard
                        title="Annual Bottles"
                        value={metrics.totalGoalBottles} 
                        icon="wine"
                        colorClass="bg-white border border-gray-100"
                    />
                </div>
            </section>

            {isTodaySabbatical && (
                <div className="mb-6 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-xl shadow-sm">
                    <p className="font-bold text-amber-700">Sabbatical Period Active (Wk {getCalendarWeek(currentDay)})</p>
                    <p className="text-sm text-amber-600">Encouragement: You are in the first 107 days. Logged drinks are considered **Exceptions**.</p>
                </div>
            )}

            <section className="mb-8 p-4 bg-white rounded-xl shadow-xl">
                <h2 className="text-lg font-bold mb-4 text-emerald-800">Log Daily Consumption (1 Drink = 1 Dram)</h2>
                <div className="grid grid-cols-2 gap-4 items-end">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Select Date</label>
                        <input
                            type="date"
                            value={selectedDate}
                            onChange={handleDateChange}
                            className="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500"
                            max={formatDate(new Date())}
                        />
                    </div>
                    <div className="text-center">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Drams/Drinks Consumed</label>
                        <div className="flex justify-between items-center space-x-2">
                            <button
                                onClick={handleDecrement}
                                className="p-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-full shadow-md transition duration-150 active:bg-gray-400 disabled:opacity-50"
                                disabled={currentDrinks <= 0}
                                aria-label="Decrement drinks"
                            >
                                <i data-lucide="minus" className="w-5 h-5"></i>
                            </button>
                            <div className="flex-grow text-center">
                                <span className="text-4xl font-extrabold text-emerald-800 tabular-nums">
                                    {currentDrinks}
                                </span>
                            </div>
                            <button
                                onClick={handleIncrement}
                                className="p-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-full shadow-md transition duration-150 active:bg-emerald-700"
                                aria-label="Increment drinks"
                            >
                                <i data-lucide="plus" className="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button
                    onClick={handleSaveLog}
                    className="mt-5 w-full bg-emerald-600 text-white py-3 rounded-xl font-semibold text-lg shadow-lg hover:bg-emerald-700 transition duration-150 transform hover:scale-[1.01]"
                >
                    {dailyLog[selectedDate] ? `Overwrite Log with ${currentDrinks} Drinks` : `Save ${currentDrinks} Drinks`}
                </button>
            </section>
            
            <section className="mb-8">
                <h2 className="text-xl font-bold mb-4 text-emerald-800">
                    Pacing Metrics
                </h2>
                <div className="grid grid-cols-3 gap-3 mb-4">
                    <MetricCard
                        title="Avg / Week"
                        value={metrics.pacingAvgPerWeek.toFixed(2)}
                        unit={`vs ${goalDrinksPerWeek.toFixed(1)} goal`}
                        icon="calculator"
                        colorClass="bg-gray-100"
                    />
                    <MetricCard
                        title="Bottle Pace"
                        value={metrics.bottlesProjected.toFixed(2)}
                        unit="Annual Pacing"
                        icon="wine"
                        colorClass={metrics.bottlesProjected > metrics.totalGoalBottles ? 'bg-red-100' : 'bg-emerald-100'}
                    />
                    <MetricCard
                        title="Total Consumed"
                        value={metrics.trackingPeriodDrinks}
                        icon="calendar-check"
                        colorClass="bg-gray-100"
                    />
                </div>
                <div className="flex space-x-4 h-24">
                    <div className="w-3/4 bg-white rounded-xl shadow-xl p-4 flex flex-col justify-center border border-gray-200">
                        <div className="flex justify-between items-center mb-1">
                            <h3 className="text-sm font-bold text-gray-700">Goal Progress (Annual Countdown)</h3>
                            <span className={`text-xl font-extrabold ${metrics.percentOfGoal > 100 ? 'text-red-600' : 'text-emerald-600'}`}>
                                {metrics.percentOfGoal.toFixed(1)}%
                            </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                                className={`h-full rounded-full transition-all duration-500 ${metrics.percentOfGoal > 100 ? 'bg-red-500' : 'bg-emerald-500'}`} 
                                style={{ width: `${Math.min(metrics.percentOfGoal, 100)}%` }}
                            ></div>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">
                            Consumed: {metrics.trackingPeriodDrinks} / {metrics.totalGoalDrinks} drinks
                        </p>
                    </div>
                    <div className="w-1/4">
                        <ReservePill 
                            value={metrics.drinksOnReserve} 
                            unit="Drinks" 
                        />
                    </div>
                </div>
                {metrics.sabbaticalExceptions > 0 && (
                     <div className="mt-4 p-3 bg-amber-50 border-l-4 border-amber-500 rounded-xl shadow-sm">
                        <p className="font-bold text-amber-700">Sabbatical Exceptions: {metrics.sabbaticalExceptions} Drinks</p>
                        <p className="text-xs text-amber-600">These were logged during the first 107 days.</p>
                    </div>
                )}
            </section>
            
            <section className="mb-8">
                <h2 className="text-xl font-bold mb-4 text-emerald-800">Weekly Log (Friday-Thursday)</h2>
                <div className="overflow-x-auto bg-white rounded-xl shadow-xl">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week #</th>
                                <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Drinks</th>
                                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {sortedWeeks.length === 0 ? (
                                <tr>
                                    <td colSpan="4" className="p-4 text-center text-gray-500 italic">No logs found yet.</td>
                                </tr>
                            ) : (
                                sortedWeeks.map((weekKey) => {
                                    const week = weeklyData[weekKey];
                                    const endDate = new Date(week.startDate);
                                    endDate.setUTCDate(week.startDate.getUTCDate() + 6);
                                    const isOver = week.totalDrinks > goalDrinksPerWeek;
                                    const isCurrentWeek = getCalendarWeek(new Date()) === week.calendarWeekNumber;
                                    const weekLabel = week.isSabbatical 
                                        ? `Sabbatical Wk ${week.calendarWeekNumber}` 
                                        : `Wk ${week.calendarWeekNumber}`;

                                    return (
                                        <tr key={weekKey} className={`transition duration-100 ${isCurrentWeek ? 'bg-emerald-100 font-semibold' : 'hover:bg-emerald-50'}`}>
                                            <td className="px-3 py-3 whitespace-nowrap text-sm text-gray-900">{weekLabel}</td>
                                            <td className="px-3 py-3 whitespace-nowrap text-xs text-gray-500">
                                                {weekKey.slice(5)} - {formatDate(endDate).slice(5)}
                                            </td>
                                            <td className="px-3 py-3 whitespace-nowrap text-sm text-right">
                                                <span className={`font-bold ${week.totalDrinks > 0 && isOver && !week.isSabbatical ? 'text-red-600' : 'text-emerald-600'}`}>
                                                    {week.totalDrinks}
                                                </span>
                                            </td>
                                            <td className="px-3 py-3 whitespace-nowrap text-sm text-right">
                                                {week.isSabbatical ? (
                                                    <span className="text-xs font-medium px-2 py-1 rounded-full bg-amber-100 text-amber-800">
                                                        Exception
                                                    </span>
                                                ) : (
                                                    <span className={`text-xs font-medium px-2 py-1 rounded-full ${isOver ? 'bg-red-100 text-red-800' : 'bg-emerald-100 text-emerald-800'}`}>
                                                        {isOver ? 'Over Goal' : 'Under Goal'}
                                                    </span>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    );
}

// --- Mount the App ---
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
